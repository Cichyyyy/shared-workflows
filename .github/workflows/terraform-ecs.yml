name: terraform-ecs

on:
  workflow_call:
    inputs:
      aws-region:
        required: true
        type: string
      tf-working-dir:
        required: true
        type: string
      plan-role-arn:
        required: true
        type: string
      apply-role-arn:
        required: true
        type: string
      run-apply:
        description: "Czy robiÄ‡ apply?"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ inputs.aws-region }}
  TF_WORKING_DIR: ${{ inputs.tf-working-dir }}

jobs:
  init_and_lint:
    name: Init / Fmt / Validate / TFLint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (PLAN role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.plan-role-arn }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check

      - name: Terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init -backend=false
          terraform validate

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: TFLint
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: tflint

  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: init_and_lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (PLAN role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.plan-role-arn }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -out=tfplan

  apply:
    name: Terraform Apply + Docker build & push
    runs-on: ubuntu-latest
    needs: plan
    if: inputs.run-apply == true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (APPLY role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.apply-role-arn }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

    #   - name: Terraform apply (ECR only)
    #     working-directory: ${{ env.TF_WORKING_DIR }}
    #     run: terraform apply -target=module.ecr -auto-approve

    #   - name: Get ECR repo URL
    #     id: ecr
    #     working-directory: ${{ env.TF_WORKING_DIR }}
    #     run: |
    #       echo "url=$(terraform output -raw ecr_repository_url)" >> $GITHUB_OUTPUT

    #   - name: Login to ECR
    #     run: |
    #       aws ecr get-login-password --region $AWS_REGION \
    #         | docker login --username AWS --password-stdin $(echo "${{ steps.ecr.outputs.url }}" | cut -d'/' -f1)

    #   - name: Build Docker image
    #     working-directory: ${{ env.TF_WORKING_DIR }}
    #     run: |
    #       docker build -t hello-api .

    #   - name: Tag & push image
    #     run: |
    #       ECR_URL="${{ steps.ecr.outputs.url }}"
    #       docker tag hello-api:latest ${ECR_URL}:latest
    #       docker push ${ECR_URL}:latest

    #   - name: Terraform apply (full)
    #     working-directory: ${{ env.TF_WORKING_DIR }}
    #     run: terraform apply -auto-approve

      - name: Terraform destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform destroy -auto-approve
